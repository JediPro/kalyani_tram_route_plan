---
title: "Kolkata Lit Meet Schedule"
author: "Pratik C"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, 
                      fig.width = 12, fig.height = 12,
                      echo = TRUE, eval = TRUE)
options(warn = 1)
```

```{r Set environment}
# Load libraries
library(tidyverse)
library(hrbrthemes)
library(lubridate)
library(scales)
library(ggtext)
library(sf)
library(ggrepel)
library(ggpp)
library(ggforce)
library(gg.layers)
library(ggalt)
library(patchwork)
library(ggfittext)
library(rvest)

# Load themes script
source(file = "C:\\Stuff\\Datasets\\vaw_themes.R")

# Set working directory
setwd("C:\\Stuff\\Datasets\\GitHub\\kalyani_tram_route_plan\\")
```

## Existing Tram Networks

```{r Existing Tram Networks}

# Read in city populations -------------------------------------
# Not usiong this as the names are in Unicode, which is difficult to map to ascii names in Wiki file
# Downloaded from https://unstats.un.org/unsd/demographic-social/products/dyb/documents/DYB2024/table08.xls
# table_city_pop <- readxl::read_xlsx(path = "city_pop.xlsx", sheet = "Data", 
#                                     trim_ws = FALSE, skip = 6,
#                                     col_types = c("text", "numeric", "skip", "numeric",
#                                                   "skip", "numeric", "skip", "numeric",
#                                                   "skip", "numeric", "skip", "numeric", 
#                                                   "skip", "numeric", "skip", "numeric", 
#                                                   "skip"),
#                                     col_names = c("territory", "city_pop_total", 
#                                                   "city_pop_male", "city_pop_female",
#                                                   "city_area",
#                                                   "urban_pop_total", "urban_pop_male", 
#                                                   "urban_pop_female", "urban_area")) %>% 
#   # First, extract the year of the estimate for each country
#   mutate(estimate_year = str_extract(string = territory, pattern = "\\d{4}"),
#          # Flag rows containing cities, which are the ones having some values
#          city_flag = !(is.na(city_pop_total) & is.na(urban_pop_total)),
#          continent_flag = (toupper(territory) == territory) & (!city_flag) & (is.na(estimate_year)),
#          country_flag = (!city_flag) & (!continent_flag) & (is.na(estimate_year)),
#          # Create columns for continent and country
#          continent = case_when(continent_flag ~ territory),
#          country = case_when(country_flag ~ territory)) %>% 
#   # Fill values
#   fill(continent, country, estimate_year, .direction = "down") %>% 
#   # Keep only rows for cities
#   filter(city_flag) %>% 
#   # Remove helper columns
#   select(-contains("flag")) %>% 
#   # Clean country and continent names
#   mutate(across(.cols = c(country, continent), 
#                 .fns = ~str_replace_all(string = .x, pattern = "-.*|\\d", 
#                                         replacement = "")),
#          # Remove brackets
#          territory = str_replace_all(string = territory, pattern = "\\(.*", replacement = "") %>% trimws())

# Fetch list of tram and metro systems ---------------------------
table_lrt_systems <- read_html("https://en.wikipedia.org/wiki/List_of_tram_and_light_rail_transit_systems") %>% 
  # Reqad in all tables in the file
  html_table(header = TRUE) %>% 
  # convert to tibble for easier wrangling
  as_tibble_col(column_name = "tbl") %>% 
  # Extract number of columns in each table
  mutate(num_col = map_int(.x = tbl, .f = ncol)) %>% 
  # Keep only tables with at least 8 columns, as they correspond to data we need
  filter(num_col >= 8) %>% 
  # Unnest all
  select(-num_col) %>% 
  # Convert to character all columns in the files
  mutate(tbl = map(.x = tbl, .f = as_tibble),
         # Rename a column in one of the files
         tbl = map(.x = tbl, .f = function(x){ x %>% 
             rename(Stations = c(contains("Stations")))}),
         tbl = map(.x = tbl, .f = function(x){ x %>% 
             mutate(across(.cols = c(Stations,  Lines), .fns = as.character))})) %>% 
  unnest(cols = tbl) %>% 
  # Rename columns
  rename(city = Location, country = Country, system = System, year = `Year opened`,
         stations = Stations, lines = Lines, length = `System length`,
         type = Type, ridership = `Annual ridership(millions)`) %>% 
  # Process fields
  mutate(across(.cols = everything(), 
                .fns = ~str_replace_all(string = .x, pattern = "\\[.*|,.*", 
                                        replacement = "")),
         # Convert to numeric
         across(.cols = c(year, stations, lines), 
                .fns = ~str_extract(string = .x, pattern = "\\d.*") %>% as.integer()),
         length = str_extract(string = length, pattern = "(.*)[\\h]km", group = 1) %>% as.numeric()) %>% 
  drop_na(year) %>% 
  # rename Washington
  mutate(city = case_when(city == "Washington" ~ "Washington DC", TRUE ~ city)) %>% 
  # Remove cities which only have heritage trams
  filter(str_detect(string = type, pattern = "^Heritage.*", negate = TRUE))

# Download world cities database from simplemaps to map ascii names to unicode names --------------------
table_city_name <- readxl::read_xlsx(path = "worldcities.xlsx") %>% 
  # Recode country names that do not match Popn table
  mutate(country = case_match(.x = country, "Korea, North" ~ "North Korea",
                              "Czechia" ~ "Czech Republic",
                              .default = country),
         city_ascii = case_when(city_ascii == "Washington" & admin_name == "District of Columbia" ~ "Washington DC",
                                TRUE ~ city_ascii),
         city = case_when(city == "Washington" & admin_name == "District of Columbia" ~ "Washington DC",
                                TRUE ~ city),
         popn = population,
         across(c(city, city_ascii, country), toupper)) %>% 
  # Some city names are duplicated, keep only the entry per city-country with highest popn
  group_by(city_ascii, country) %>% 
  slice_max(order_by = population, n = 1) %>% ungroup() %>% 
  # Recode city names
  mutate(city_ascii = case_match(.x = city_ascii,
                                 "AR RAYYAN" ~ "AL RAYYAN",
                                "BRANDENBURG" ~ "BRANDENBURG AN DER HAVEL",
                                "CH'ONGJIN" ~ "CHONGJIN",
                                "ERFURT" ~ "ERFURT",
                                "FRANKFURT" ~ "FRANKFURT AM MAIN",
                                "GALATI" ~ "GALAȚI",
                                "GENT" ~ "GHENT",
                                "COPENHAGEN" ~ "GREATER COPENHAGEN",
                                "HANNOVER" ~ "HANOVER",
                                "IASI" ~ "IAȘI",
                                "JINAN" ~ "JINAN ",
                                "KAMAKURAYAMA" ~ "KAMAKURA",
                                "KATOWICE" ~ "KATOWICE AND ITS AREA",
                                "KRASNOTUR'INSK" ~ "KRASNOTURYINSK",
                                "LUZHANG" ~ "LIJIANG",
                                "MINNEAPOLIS" ~ "MINNEAPOLIS–SAINT PAUL",
                                "NABEREZHNYYE CHELNY" ~ "NABEREZHNYE CHELNY",
                                "TAIPEI" ~ "NEW TAIPEI",
                                "NEWCASTLE" ~ "NEWCASTLE UPON TYNE",
                                "NIZHNIY NOVGOROD" ~ "NIZHNY NOVGOROD",
                                "NIZHNIY TAGIL" ~ "NIZHNY TAGIL",
                                "NAVAPOLATSK" ~ "NOVOPOLOTSK",
                                "OREL" ~ "ORYOL",
                                "PADOVA" ~ "PADUA",
                                "PLOIESTI" ~ "PLOIEȘTI",
                                "PORT LOUIS" ~ "PORT LOUIS AND THE DISTRICT OF PLAINES WILHEMS",
                                "RESITA" ~ "REȘIȚA",
                                "ROSTOV" ~ "ROSTOV-ON-DON",
                                "SANTA CRUZ" ~ "SANTA CRUZ DE TENERIFE",
                                "SANTOS" ~ "SANTOS AND THE METROPOLITAN REGION OF BAIXADA SANTISTA",
                                "SEVILLA" ~ "SEVILLE",
                                "STARYY OSKOL" ~ "STARY OSKOL",
                                "TEL AVIV-YAFO" ~ "TEL AVIV",
                                "TIMISOARA" ~ "TIMIȘOARA",
                                "USOL'YE-SIBIRSKOYE" ~ "USOLYE-SIBIRSKOYE",
                                "VITSYEBSK" ~ "VITEBSK",
                                "YEVPATORIIA" ~ "YEVPATORIA",
                                "KOCAELI" ~ "İZMIT", 
                                .default = city_ascii
))

# Create table combining system and population information -----------------------
data_lrt_pop <- table_lrt_systems %>% 
  # Some cities have multiple rows, sum up the values for them
  group_by(city, country) %>% 
  summarise(across(.cols = c(stations, lines, length), 
                   .fns = ~sum(.x, na.rm = TRUE)),
            .groups = "drop") %>% 
  mutate(across(c(city, country), toupper)) %>% 
  # Map popn to ascii codes city
  left_join(y = table_city_name %>% select(city_ascii, country, popn),
            by = c("city" = "city_ascii", "country")) %>% 
  # Map popn to unicode coded city
  left_join(y = table_city_name %>% select(city, country, popn),
            by = c("city" = "city", "country"), suffix = c("_1", "_2")) %>% 
  # Consider overlap in population columns
  mutate(popn = case_when(is.na(popn_1) ~ popn_2, TRUE ~ popn_1),
         # Fill in populations for missing cities manually
         popn = case_match(.x = city,
                           "BAD SCHANDAU" ~ 3409,
                          "BELGIAN COAST" ~ 219488,
                          "CHERYOMUSHKI" ~ 10000,
                          "DESSAU" ~ 67747,
                          "ERFURT" ~ 216000,
                          "HUDSON COUNTY" ~ 724854,
                          "LUND" ~ 94393,
                          "LUSAIL" ~ 198600,
                          "MENGZI" ~ 585976,
                          "OSINNIKI" ~ 40000,
                          "QIUBEI" ~ 468172,
                          "TIANSHUI" ~ 1212791,
                          "VOLCHANSK" ~ 8000,
                          "VOLZHSKY" ~ 321427,
                          .default = popn)) %>% 
  # Remove helper columns
  select(-popn_1, -popn_2) %>% 
  # Replace 0 in stations and lines with NA
  mutate(across(.cols = c(stations, lines), ~na_if(x = .x, y = 0)))
```

## Visualize relations between route characteristics and city population

```{r Routes vs Population}
# Plot Length vs Stations --------------------------------
plot_length_stations <- data_lrt_pop %>% 
  # plot
  ggplot() +
  # points
  geom_point(mapping = aes(x = length, y = stations), size = 2, 
             alpha = 0.8, colour = "firebrick") +
  geom_smooth(mapping = aes(x = length, y = stations), linewidth = 1,
              colour = "dodgerblue", alpha = 0.2, fill = "dodgerblue", 
              method = "lm") +
  # Scales
  scale_x_continuous(name = "Route Length", 
                     expand = expansion(mult = c(0.01, 0.01)), trans = "log10") +
  scale_y_continuous(name = "Stations", 
                     expand = expansion(mult = c(0.01, 0.01)), trans = "log10") +
  # Labels
  labs(title = "Stations vs Route Length") +
  theme_vaw_dark()

# Model Length vs Stations ----------------------
mod_length_stations <- lm(formula = log10(stations) ~ log10(length), 
                          data = data_lrt_pop, na.action = na.omit)
yardstick::rsq_trad_vec(truth = mod_length_stations$model$`log10(stations)`, 
                        estimate = mod_length_stations$fitted.values)



```

